# 成长小精灵课堂互动系统 PRD 文档

> **文档版本**: v3.4
> **最后更新**: 2025-11-08
> **文档类型**: 产品需求文档 (Product Requirements Document)

---

## 📋 目录

- [一、产品概述](#一产品概述)
- [二、系统架构](#二系统架构)
- [三、功能详细设计](#三功能详细设计)
  - [3.1 主页面：核心管理页](#31-主页面核心管理页)
  - [3.2 随机点名挑战页](#32-随机点名挑战页)
  - [3.3 转盘抽奖页](#33-转盘抽奖页)
  - [3.4 声音互动页](#34-声音互动页)
  - [3.5 积分商店页](#35-积分商店页)
  - [3.6 成绩管理页](#36-成绩管理页)
- [四、非功能性需求](#四非功能性需求)
  - [4.5 数据备份与恢复](#45-数据备份与恢复)
- [五、数据模型与流转](#五数据模型与流转)

---

## 一、产品概述

### 1.1 产品定位

**成长小精灵课堂互动系统**是一款面向K12教师的课堂互动与学生激励工具。通过**游戏化机制**（精灵进化系统）与**多场景互动功能**的有机结合，实现学生数据管理、课堂互动、积分激励的一体化解决方案，有效提升课堂趣味性和学生参与度。

### 1.2 核心价值

| 价值维度           | 具体体现                                                 |
| ------------------ | -------------------------------------------------------- |
| **效率提升** | 简化教师对学生的积分管理与课堂互动操作流程               |
| **激励机制** | 精灵进化、积分兑换等游戏化机制激发学生学习积极性         |
| **场景覆盖** | 全面覆盖点名问答、朗读练习、积分消耗、奖励兑换等课堂场景 |
| **数据管理** | 统一管理学生数据、成绩记录，支持批量导入导出             |

### 1.3 用户角色

- **唯一用户**: 教师
- **权限范围**: 系统配置、功能操作、学生数据管理

### 1.4 核心机制

#### 1.4.1 数据关联规则

```
学生核心数据（全局共享）:
├─ 基础信息: 姓名、学号
├─ 积分系统: 当前积分、积分历史
├─ 成长系统: 精灵品种、进化阶段、经验值
└─ 成绩系统: 各科成绩记录、经验值来源
```

**数据同步规则**：

- ✅ 所有页面共享同一数据源，一处修改全局同步
- ✅ 积分是核心流转数据：互动产生积分，消耗功能扣除积分
- ✅ 经验是独立成长数据：课堂互动与考试成绩产生经验值，累计达标自动升级并获得积分奖励

#### 1.4.2 精灵进化体系

| 阶段 | 等级 | 阶段名称   | 累计经验值要求 | 本阶段所需经验 | 升级奖励 | 特征描述           |
| ---- | ---- | ---------- | -------------- | -------------- | -------- | ------------------ |
| 1    | Lv.1 | 精灵蛋     | 0              | -              | -        | 初始状态，等待孵化 |
| 2    | Lv.2 | 萌新宝宝   | 30             | 30             | 10 积分  | 刚刚孵化的小生命   |
| 3    | Lv.3 | 活力小宝   | 80             | 50             | 10 积分  | 充满好奇与活力     |
| 4    | Lv.4 | 成长小精灵 | 160            | 80             | 10 积分  | 快速成长阶段       |
| 5    | Lv.5 | 智慧精灵   | 280            | 120            | 10 积分  | 开始展现智慧       |
| 6    | Lv.6 | 勇敢战士   | 460            | 180            | 10 积分  | 勇敢面对挑战       |
| 7    | Lv.7 | 闪耀明星   | 710            | 250            | 10 积分  | 光芒四射的明星     |
| 8    | Lv.8 | 魔法大师   | 1060           | 350            | 10 积分  | 掌握强大的力量     |
| 9    | Lv.9 | 终极神兽   | 1560           | 500            | 10 积分  | 达到巅峰状态       |

**升级规则说明**：

- **累计经验值要求**：学生的总经验值达到此数值即可升级到对应阶段
- **本阶段所需经验**：从上一阶段升级到当前阶段需要获得的经验值增量
- **升级奖励**：每次升级自动获得的积分奖励（可在系统配置中自定义调整）
- **进化特性**：经验值达标后自动触发进化，无需手动操作
- **连续升级规则**：当一次性获得大量经验值导致跨越多个等级时：
  - 自动计算最终等级
  - 升级奖励积分按跨越等级累计（如 Lv.2→Lv.5，奖励 = 10+10+10 = 30 积分）
  - 仅播放一次进化动画，显示最终进化结果（如"恭喜！你的精灵连续进化到 Lv.5！"）

**经验值获取途径**：

1. 📚 课堂互动（随机点名回答问题等）
2. 📝 考试成绩换算（按配置规则自动计算）
3. 👨‍🏫 教师手动奖励（支持单个/批量操作）

> **💡 设计理念**：递进式难度设计，后期升级所需经验值逐渐增加，让学生感受到成长的挑战性和成就感

#### 1.4.3 精灵品种体系

**可选品种**：

系统提供三种精灵品种供学生选择，每种品种都有独特的视觉风格和成长形态：

| 品种序号 | 品种名称 | 视觉特征               | 适合学生类型     |
| -------- | -------- | ---------------------- | ---------------- |
| 1        | 星尘神兽 | 紫色星空主题，闪耀神秘 | 喜欢梦幻星空风格 |
| 2        | 灵鹿神兽 | 粉色优雅主题，温柔灵动 | 喜欢温暖优雅风格 |
| 3        | 彩雾神兽 | 彩虹渐变主题，梦幻多彩 | 喜欢缤纷彩色风格 |

**选择规则**：

- 每个学生必须选择一种精灵品种
- 品种一旦选择，不可更改（保持陪伴感和归属感）
- 不同品种仅影响视觉展示，不影响成长速度和能力

**选择时机**：

1. **新增学生时**：可选填精灵品种，若留空则在首次操作学生卡片时补充选择
2. **批量导入时**：可在 Excel 表格中指定品种，若留空则在首次操作学生卡片时补充选择
3. **首次操作时**：未选择品种的学生，在以下任一操作中首次触发时，系统会自动弹出品种选择对话框：
   - 主页面查看学生卡片（首次加载主页面时）
   - 随机点名页面点击"开始点名"时（若抽中未选择品种的学生）
   - 成绩管理页选择该学生时
   - 转盘抽奖页选择该学生时
   - 积分商店页选择该学生时
   - 其他任何需要展示精灵形象的页面或操作

**触发优先级与视觉反馈**：

- **未选择品种的学生卡片处理**：
  - 卡片不展示精灵形象，显示"未选择品种"占位图
  - 卡片显示"选择品种"按钮（醒目标识）
  - 卡片其他信息正常显示（姓名、积分、经验值等）
- **首次操作定义**：点击学生卡片上的任何操作按钮（如"成绩录入"、"奖励加分"、"选择品种"）
- **触发时机**：点击操作按钮时，若该学生未选择品种，立即弹出品种选择对话框
- **其他页面处理**：随机点名、转盘抽奖、积分商店等页面，若选中未选品种学生，操作前自动弹出品种选择对话框

**品种选择对话框设计**：

```
┌─────────────────────────────────────┐
│  选择你的专属小精灵                  │
├─────────────────────────────────────┤
│  学生：张三                          │
├─────────────────────────────────────┤
│  请为你的小精灵选择一个品种：        │
│                                     │
│  ┌─────┐  ┌─────┐  ┌─────┐        │
│  │ 🌟  │  │ 🦌  │  │ 🌈  │        │
│  │星尘 │  │灵鹿 │  │彩雾 │        │
│  │神兽 │  │神兽 │  │神兽 │        │
│  └─────┘  └─────┘  └─────┘        │
│    [选择]    [选择]    [选择]      │
│                                     │
│  ⚠️ 提示：品种选择后不可更改        │
└─────────────────────────────────────┘
```

**交互反馈**：

- 悬停时显示品种预览图（精灵蛋阶段）
- 点击选择后立即关闭对话框
- 弹出"恭喜！你获得了 {{品种名称}}！"提示
- 学生卡片实时更新精灵形象

---

## 二、系统架构

### 2.1 页面结构

```
成长小精灵课堂互动系统
│
├─ 📊 主页面 (核心管理页)
│   ├─ 学生数据管理模块
│   ├─ 精灵进化展示模块
│   ├─ 快速成绩录入模块 ✨ NEW
│   └─ 系统配置模块
│
├─ 🎲 互动功能页
│   ├─ 随机点名挑战页
│   ├─ 转盘抽奖页
│   ├─ 声音互动页
│   └─ 积分商店页
│
├─ 📝 成绩管理页
│   ├─ 学生选择模块
│   ├─ 精灵预览模块
│   ├─ 手动成绩录入模块
│   ├─ 批量导入成绩模块
│   └─ 成绩历史查看模块
│
└─ 💾 备份管理页 ✨ NEW
    ├─ 自动备份列表模块
    ├─ 临时备份列表模块
    ├─ 手动备份操作模块
    └─ 操作日志模块
```

### 2.2 数据流转关系

```
课堂互动 ──积分产出──→ 学生积分池 ──积分消耗──→ 抽奖/商店兑换
    ↓                      ↑
经验值产出              升级奖励积分
    ↓                      ↑
经验值累计 ──达到阈值──→ 精灵进化
    ↑  
考试成绩换算 + 教师手动操作
```

---

## 三、功能详细设计

### 3.1 主页面：核心管理页

#### 3.1.1 模块定位

系统总入口，负责学生数据管理、精灵进化规则展示、基础配置设置、快速成绩录入。提供一站式的课堂管理功能，教师无需频繁跳转页面即可完成核心操作。

---

#### 3.1.2 学生数据管理模块

##### 3.1.2.1 添加学生

**操作流程**：

1. 点击"添加学生"按钮
2. 填写表单字段：
   - 学生姓名（必填）
   - 学生学号（选填）
   - 初始积分（选填，默认 0）
   - 初始经验值（选填，默认 0）
   - 精灵品种（选填，可后续补充）
3. 点击确认，生成学生卡片

**交互反馈**：

- ✅ 成功：弹出"添加成功"提示，学生卡片实时显示
- ❌ 失败：未填写姓名时提示"请输入学生姓名"
- ❌ 姓名重复：系统自动去除姓名前后空格后检测重复，若重复提示"该学生姓名已存在"
- ⚠️ 特殊情况：未选择精灵品种的学生，首次涉及精灵展示的操作时，自动弹出精灵品种选择对话框（详见 [1.4.3 精灵品种体系](#143-精灵品种体系)）

**姓名处理规则**：

- 系统自动去除姓名前后空格（例如："　张三　" 自动转为 "张三"）
- 姓名唯一性检测：去除空格后的姓名不可重复
- 区分大小写（"张三" 与 "张三" 为同一姓名）

---

##### 3.1.2.2 批量导入/导出数据

**导入功能**：

| 功能项               | 说明                                                                             |
| -------------------- | -------------------------------------------------------------------------------- |
| **支持格式**   | Excel (.xlsx)                                                                    |
| **必填字段**   | 学生姓名                                                                         |
| **选填字段**   | 学生学号、积分、经验值、精灵品种                                                 |
| **默认值处理** | 留空字段按默认值处理（积分=0，经验值=0）                                         |
| **精灵品种**   | 可填写"星尘神兽"、"灵鹿神兽"或"彩雾神兽"，留空则首次操作时弹出选择对话框补充选择 |

**导出功能**：

| 功能项               | 说明                               |
| -------------------- | ---------------------------------- |
| **导出范围**   | 当前所有学生数据                   |
| **必导出字段** | 学生姓名                           |
| **可选字段**   | 学生学号、精灵品种、积分、经验值（默认全选） |
| **导出格式**   | Excel (.xlsx)                      |

**说明**：

- 进化阶段由经验值自动计算，无需导出导入
- 导出的数据可直接用于批量导入，无需额外处理

**交互反馈**：

- 导入成功后显示"成功导入 N 条数据"
- 导入失败时显示具体错误原因和行号

---

##### 3.1.2.3 删除学生

**功能说明**：

系统支持单个删除和批量删除学生数据。

---

**单个删除**：

1. 在学生卡片右上角点击"删除"按钮（❌ 图标）
2. 弹出二次确认对话框："确定要删除学生 {{姓名}} 吗？此操作不可恢复。"
3. 点击"确认删除"
4. 系统删除该学生的所有数据
5. 学生卡片从页面移除

---

**批量删除**：

**选择学生交互设计**：（同批量积分奖励）

- 每个学生卡片左上角显示复选框
- 顶部工具栏显示"全选"、"反选"、"清空选择"按钮
- 已选中学生数量实时显示（如"已选中 5 名学生"）
- 选中状态：卡片边框高亮显示

**操作流程**：

1. 使用复选框多选学生
2. 点击顶部操作栏的"批量删除"按钮
3. 弹出二次确认对话框："确定要删除选中的 {{数量}} 名学生吗？此操作不可恢复。"
4. 点击"确认删除"
5. 系统批量删除选中学生的所有数据
6. 显示删除结果："成功删除 X 名学生"
7. 自动清空选择状态

---

**删除影响范围**：

删除学生时，系统会同步删除以下所有相关数据：

- 学生基本信息（姓名、学号）
- 积分数据（当前积分、积分历史记录）
- 经验值数据（当前经验值、经验历史记录）
- 精灵信息（品种、进化阶段）
- 成绩记录（所有科目的历史成绩）
- 抽奖记录（转盘抽奖历史）
- 兑换记录（积分商店兑换历史）

---

**撤销机制**：

- 批量删除操作支持撤销（详见 [3.1.2.6 撤销/重做功能](#3126-撤销重做功能)）
- 单个删除操作不支持撤销（建议谨慎操作）
- 撤销记录：系统保留最近 15 次批量操作记录

---

**交互反馈**：

- 删除成功后显示"删除成功"提示
- 若删除失败，显示具体错误原因
- 删除操作会记录到操作日志

---

**约束条件**：

- 删除操作需二次确认，防止误操作
- 删除后数据不可恢复（除非撤销批量删除操作，系统保留最近15次操作记录）
- 系统至少保留 0 个学生（允许删除所有学生）

---

##### 3.1.2.4 积分操作

**说明**：主页面提供两种积分奖励方式（系统仅支持加分，无扣分功能）：

1. **顶部批量奖励**：用于批量加分
2. **卡片快速奖励**：用于单个学生快速加分

---

**批量积分奖励**（顶部操作按钮）：

**选择学生交互设计**：

- 每个学生卡片左上角显示复选框
- 顶部工具栏显示"全选"、"反选"、"清空选择"按钮
- 已选中学生数量实时显示（如"已选中 5 名学生"）
- 选中状态：卡片边框高亮显示

**操作流程**：

1. 使用复选框多选学生
2. 点击顶部"批量奖励积分"按钮
3. 弹出批量奖励对话框：
   - 显示已选中学生数量
   - 输入统一的奖励积分数值（必须为正整数）
   - 选择或输入奖励原因（支持预定义选项 + 手动输入）
4. 确认后批量更新
5. 以列表形式展示成功/失败状态
6. 自动清空选择状态

**奖励原因预定义选项**：

- 课堂表现优秀
- 作业完成出色
- 考试进步显著
- 帮助同学
- 积极参与活动
- 自定义...

**约束条件**：

- 积分数值必须为正整数（1, 2, 3...）
- 系统不支持扣分操作，积分激励采用正向奖励机制

---

**卡片快速奖励**：

详见 [3.1.3.4 快速成绩录入](#3134-快速成绩录入) 中的"功能二：奖励加分"

---

##### 3.1.2.5 经验值操作

**说明**：主页面提供两种经验值操作方式：

1. **顶部批量操作**：用于批量增加经验值
2. **卡片快速操作**：用于单个学生快速奖励经验值

---

**批量经验值操作**（顶部操作按钮）：

**选择学生交互设计**：（同批量积分奖励）

- 每个学生卡片左上角显示复选框
- 顶部工具栏显示"全选"、"反选"、"清空选择"按钮
- 已选中学生数量实时显示（如"已选中 5 名学生"）
- 选中状态：卡片边框高亮显示

**操作流程**：

1. 使用复选框多选学生
2. 点击顶部"批量奖励经验值"按钮
3. 弹出批量奖励对话框：
   - 显示已选中学生数量
   - 输入统一增加的经验值数量（必须为正整数）
   - 选择或输入操作原因（支持预定义选项 + 手动输入）
4. 确认后批量更新
5. 以列表形式展示成功/失败状态
6. 自动清空选择状态

**操作原因预定义选项**：

- 课外作业完成优秀
- 课外活动表现突出
- 特殊奖励
- 课堂表现优异
- 自定义...

---

**卡片快速奖励**：

详见 [3.1.3.4 快速成绩录入](#3134-快速成绩录入) 中的"功能二：奖励加分"

---

**特别说明**：

- 经验值只能增加，不能减少
- 经验值数量必须为正整数（1, 2, 3...）
- 经验值变化后，若达到升级条件，自动触发精灵进化

---

##### 3.1.2.6 撤销/重做功能

**支持操作类型**：

- 积分批量奖励
- 经验值批量奖励
- 学生批量删除
- 批量导入数据

**功能规格**：

| 规格项                 | 说明                                                   |
| ---------------------- | ------------------------------------------------------ |
| **操作记录数量** | 最近 15 次关键操作，超过自动删除最早记录               |
| **记录内容**     | 操作类型、影响范围、变更前后数据对比                   |
| **撤销机制**     | 操作后界面顶部显示"撤销"按钮，点击恢复操作前状态       |
| **重做机制**     | 撤销后"撤销"按钮变为"重做"按钮，可重新执行被撤销的操作 |
| **自动清理**     | 保留最近 15 条操作记录，超过数量自动删除最早记录       |

**交互反馈**：

- 批量操作撤销时，显示影响的学生列表摘要
- 当执行第 16 次操作时，最早的第 1 条记录自动删除
- 撤销按钮悬停时显示："可撤销最近 15 次批量操作"

---

##### 3.1.2.7 经验获取

**经验值来源**：

- 📚 课堂互动（点名、回答问题等）
- 📝 考试成绩换算
- 👨‍🏫 教师手动奖励经验（单个或批量操作）

**特性**：

- 经验值独立累计，不直接影响积分
- 经验值达到升级条件时触发精灵进化，进化时获得积分奖励
- 教师可根据学生表现灵活奖励经验值（仅支持增加）

---

##### 3.1.2.8 异常处理

| 场景             | 处理方式                                                                                                    |
| ---------------- | ----------------------------------------------------------------------------------------------------------- |
| 无学生数据       | 所有依赖学生的操作按钮置灰，显示"暂无学生数据，请先添加学生或导入数据"                                     |
| 未选择精灵品种   | 首次涉及精灵展示的操作时，自动弹出精灵品种选择对话框，必须选择一个品种后才能继续（详见 1.4.3 精灵品种体系） |
| 积分不足         | 功能页面中对应学生置灰，标注"积分不足"                                                                       |
| 输入非正整数经验 | 经验值操作时，若输入非正整数，提示"请输入正整数"                                                             |

---

#### 3.1.3 精灵进化展示模块

##### 3.1.3.1 进化规则

详见 [1.4.2 精灵进化体系](#142-精灵进化体系)

##### 3.1.3.2 进度展示

**学生卡片显示内容**：

- 学生姓名
- 当前积分
- 精灵品种
- 精灵形象（对应当前阶段）
- 精灵阶段名称
- 快速操作按钮区

##### 3.1.3.3 进化触发

**触发条件**：当前经验值 ≥ 下一阶段所需经验值

**触发效果**：

1. 自动弹出"🎉 进化成功！你的小精灵进化到新的阶段！"提示
2. 展示"进化前/后"对比动画
3. 自动奖励积分（默认 10 积分，可在系统配置中调整）
4. 学生卡片精灵形象自动更新为新阶段样式

**交互反馈**：

- 进化动画时长约 2-3 秒
- 进化成功后播放欢快音效
- 积分奖励实时累加到学生积分池

##### 3.1.3.4 快速成绩录入

**功能定位**：

在学生卡片上提供快速成绩录入入口，无需跳转到成绩管理页即可完成成绩录入。

**卡片快速操作区**：

学生卡片底部包含快速操作按钮组：

- 📝 **成绩录入** 按钮
- ⭐ **奖励加分** 按钮

---

**功能一：成绩录入**

**操作流程**：

1. 点击学生卡片上的"📝 成绩录入"按钮
2. 弹出成绩录入对话框（浮层）：
   - 显示学生姓名和精灵预览
   - 科目选择下拉列表（所有已配置科目）
   - 成绩输入框（0-100）
   - "提交"和"取消"按钮
3. 选择科目，输入成绩
4. 点击"提交"
5. 系统自动：
   - 记录当前时间为录入时间
   - 按配置规则换算为经验值并累加
   - 关闭对话框
   - 卡片上的经验进度条实时更新
6. 若触发进化，自动播放进化动画

**对话框设计**：

```
┌─────────────────────────────────────┐
│  成绩录入                            │
├─────────────────────────────────────┤
│  学生：张三                          │
│  精灵：🐰 萌新宝宝 Lv.2              │
├─────────────────────────────────────┤
│  科目：[语文 ▼]                     │
│  成绩：[____] (0-100)               │
├─────────────────────────────────────┤
│           [取消]  [提交]            │
└─────────────────────────────────────┘
```

**交互反馈**：

- 成绩输入实时验证（0-100 范围）
- 提交成功后显示"录入成功，获得 X 经验值"
- 卡片经验进度条平滑动画更新
- 若触发进化，对话框关闭后播放进化动画
- 支持连续录入：提交后对话框不关闭，清空成绩输入框，可继续录入其他科目

**与成绩管理页的关系**：

- 成绩录入的数据与成绩管理页完全同步
- 数据共享同一来源
- 录入的成绩在成绩管理页的历史记录中可查看
- 适用场景：
  - **卡片成绩录入**：课堂上即时录入单科成绩
  - **成绩管理页**：批量导入、查看历史、系统化管理

---

**功能二：奖励加分**

**操作流程**：

1. 点击学生卡片上的"⭐ 奖励加分"按钮
2. 弹出奖励加分对话框（浮层）：
   - 显示学生姓名和精灵预览
   - 显示当前积分和经验值
   - 奖励类型选择（单选）：
     - 🪙 **积分奖励**
     - ⚡ **经验奖励**
   - 数值输入框（正整数）
   - 原因输入框（可选）
   - "提交"和"取消"按钮
3. 选择奖励类型，输入数值和原因
4. 点击"提交"
5. 系统自动更新对应数据
6. 若为经验奖励且触发进化，自动播放进化动画

**对话框设计**：

```
┌─────────────────────────────────────┐
│  奖励加分                            │
├─────────────────────────────────────┤
│  学生：张三                          │
│  精灵：🐰 萌新宝宝 Lv.2              │
│  当前：积分 50 | 经验 25/30          │
├─────────────────────────────────────┤
│  奖励类型：                          │
│    ◉ 🪙 积分奖励                    │
│    ○ ⚡ 经验奖励                    │
├─────────────────────────────────────┤
│  奖励数值：[____] (正整数)          │
│  奖励原因：[____] (可选)            │
├─────────────────────────────────────┤
│           [取消]  [提交]            │
└─────────────────────────────────────┘
```

**预定义原因选项**：

积分奖励原因：

- 课堂表现优秀
- 作业完成出色
- 帮助同学
- 考试进步显著
- 自定义...

经验奖励原因：

- 课外作业完成优秀
- 课外活动表现突出
- 特殊奖励
- 课堂表现优异
- 自定义...

**交互反馈**：

- 数值输入实时验证（必须为正整数）
- 提交成功后显示：
  - 积分奖励："✅ 成功奖励 X 积分"
  - 经验奖励："✅ 成功奖励 X 经验值"
- 卡片数据实时更新（积分或经验进度条）
- 若触发进化，对话框关闭后播放进化动画

**约束条件**：

- 奖励数值必须为正整数（1, 2, 3...）
- 原因可以为空，也可以从预定义选项中选择或自定义输入
- 积分奖励支持正整数，无上限
- 经验奖励只能增加，不能减少

---

#### 3.1.4 系统配置模块

##### 3.1.4.1 展示设置

| 配置项               | 可选值                    | 默认值     | 说明                   |
| -------------------- | ------------------------- | ---------- | ---------------------- |
| **一行卡片数** | 3-12                      | 6          | 学生卡片每行显示数量   |
| **排序方式**   | 按积分排序 / 按经验值排序 | 按积分排序 | 选择后实时刷新卡片排序 |

##### 3.1.4.2 精灵进化配置

**配置项一览**：

| 配置类型                 | 说明                     | 可配置内容               |
| ------------------------ | ------------------------ | ------------------------ |
| **等级经验值配置** | 每个等级所需的累计经验值 | Lv.1-Lv.9 的经验值阈值   |
| **升级奖励配置**   | 每次升级奖励的积分数量   | Lv.2-Lv.9 的升级奖励积分 |

---

**1. 等级经验值配置**

支持自定义每个等级所需的累计经验值：

| 等级 | 默认值 | 建议范围   | 约束条件    |
| ---- | ------ | ---------- | ----------- |
| Lv.1 | 0      | 固定不可改 | 初始状态    |
| Lv.2 | 30     | 10-100     | 必须 > 0    |
| Lv.3 | 80     | 50-200     | 必须 > Lv.2 |
| Lv.4 | 160    | 100-400    | 必须 > Lv.3 |
| Lv.5 | 280    | 200-700    | 必须 > Lv.4 |
| Lv.6 | 460    | 300-1000   | 必须 > Lv.5 |
| Lv.7 | 710    | 500-1500   | 必须 > Lv.6 |
| Lv.8 | 1060   | 800-2500   | 必须 > Lv.7 |
| Lv.9 | 1560   | 1200-5000  | 必须 > Lv.8 |

---

**2. 升级奖励积分配置**

支持为每个等级单独设置升级奖励积分：

| 升级路径   | 默认值  | 建议范围   | 说明           |
| ---------- | ------- | ---------- | -------------- |
| Lv.1→Lv.2 | 10 积分 | 1-100 积分 | 第一次进化奖励 |
| Lv.2→Lv.3 | 10 积分 | 1-100 积分 | 第二次进化奖励 |
| Lv.3→Lv.4 | 10 积分 | 1-100 积分 | 第三次进化奖励 |
| Lv.4→Lv.5 | 10 积分 | 1-100 积分 | 第四次进化奖励 |
| Lv.5→Lv.6 | 10 积分 | 1-100 积分 | 第五次进化奖励 |
| Lv.6→Lv.7 | 10 积分 | 1-100 积分 | 第六次进化奖励 |
| Lv.7→Lv.8 | 10 积分 | 1-100 积分 | 第七次进化奖励 |
| Lv.8→Lv.9 | 10 积分 | 1-100 积分 | 第八次进化奖励 |

**配置建议**：

- 统一奖励：所有等级相同积分（如统一 10 积分）
- 递增奖励：等级越高奖励越多（如 5, 8, 10, 12, 15, 18, 20, 25）
- 里程碑奖励：关键等级特别奖励（如 Lv.5、Lv.9 给予 20 积分）

---

**3. 操作流程**

1. 点击主页面"精灵进化配置"按钮
2. 弹出配置对话框，显示当前配置（带默认值）
3. 教师直接修改需要调整的等级经验值或奖励积分
4. 系统实时显示：
   - 每级所需经验增量（自动计算）
   - 总经验值和总奖励积分统计
5. 点击"保存配置"
6. 系统显示确认对话框："配置修改将影响所有学生，是否确认？"
7. 确认后即时生效

---

**4. 交互反馈与验证**

**实时验证**：

- 经验值输入框旁显示"上一级: XXX，必须 > XXX"
- 输入不符合递增规则时，输入框标红并提示"经验值必须大于上一级"
- 所有输入必须为正整数，非数字输入时提示"请输入有效数字"

**配置预览**：

- 显示完整的 9 级进化配置表格
- 实时计算"本级所需经验"（自动计算增量）
- 显示统计信息：总经验值、总奖励积分

**保存后反馈**：

- 提示"配置已更新"
- 若有学生因新配置达到升级条件，显示"提示：3 名学生将触发进化"

**说明**：

- 此配置影响所有学生的精灵进化规则，是全局性质的配置项
- 配置修改后，所有学生按新规则判断进化（已有经验值保持不变）
- 首次使用时，所有配置项已填充默认值，教师可直接使用或按需修改

##### 3.1.4.3 交互反馈

- 所有配置修改后即时生效，无需刷新页面
- 配置保存成功后显示"配置已更新"提示

---

#### 3.1.5 页面元素与约束

**页面元素**：

- 学生卡片网格（包含快速操作按钮）
- 顶部操作按钮组：添加学生、导入数据、导出数据、批量奖励积分、批量奖励经验值、系统配置
- 卡片快速操作按钮：
  - 📝 成绩录入
  - ⭐ 奖励加分
- 系统配置面板
- 页面导航按钮：随机点名、转盘抽奖、声音互动、积分商店、成绩管理
- 快速操作对话框：
  - 成绩录入对话框
  - 奖励加分对话框

**约束条件**：

- 系统仅支持正向奖励机制，所有积分和经验值操作仅支持加分，不支持扣分
- 积分和经验值数值必须为正整数（1, 2, 3...）
- 精灵阶段由经验值自动控制（达到阈值自动进化），不可手动直接修改阶段
- 学生姓名不可重复
- 快速成绩录入的成绩必须在 0-100 范围内

---

### 3.2 随机点名页

#### 3.2.1 模块定位

课堂问答互动工具，通过随机点名机制结合经验值奖励，提升学生课堂参与度。

---

#### 3.2.2 随机点名模块

##### 3.2.2.1 点名池管理

**功能说明**：

- 系统维护"待点名池"和"已点名池"两个学生列表
- 点名时仅从"待点名池"中随机抽取，确保公平性
- 支持重置点名池，开启新一轮点名

**界面显示**：

- 页面顶部显示统计信息："待点名: 25人 | 已点名: 5人"
- 提供"重置点名池"按钮
- 已点名学生在列表中显示为灰色（可选显示/隐藏）

**点名池规则**：

1. **初始化**：所有学生进入"待点名池"
2. **点名后**：被点名的学生自动移入"已点名池"
3. **重置**：点击"重置点名池"按钮，所有学生回到"待点名池"
4. **池空处理**：当待点名池为空时，提示"本轮点名已完成，所有学生都已被点名一次。是否重置点名池开始新一轮？"

##### 3.2.2.2 操作流程

1. 点击"开始点名啦"按钮
2. 系统从"待点名池"中随机滚动学生名单（动画效果：名单像魔法转盘一样欢快转动）
3. 滚动时长 3 秒，每秒约切换 12 次学生姓名
4. 3 秒后动画逐渐减速
5. 最终弹出选中学生姓名卡片（蹦跳动画 0.3 秒）
6. 该学生自动移入"已点名池"，待点名人数 -1

##### 3.2.2.3 动画效果

**滚动过程**：

- 按钮变为彩色，显示"魔法点名中～"，周围环绕闪亮星星特效
- 学生姓名带小爱心和星星特效，飞进飞出

**选中瞬间**：

- 播放"叮咚～"清脆提示音
- 被点名学生卡片放大并绽放彩色花朵动画（0.5 秒）

**点名结束**：

- 按钮恢复原样
- 卡片回到正常大小

##### 3.2.2.4 异常处理

| 场景         | 处理方式                                                       |
| ------------ | -------------------------------------------------------------- |
| 无学生数据   | 按钮晃动，弹出红色小云朵提示"还没有小朋友呢，快来添加吧～"     |
| 待点名池为空 | 提示"本轮点名已完成，所有学生都已被点名一次。是否重置点名池？" |

---

#### 3.2.3 答题结果与经验值奖励模块

##### 3.2.3.1 结果选择

点名后显示两个按钮：

- ✅ 挑战成功
- ❌ 挑战失败

教师根据学生答题情况点击选择

##### 3.2.3.2 经验反馈

**挑战成功**：

- 提示："太棒了！恭喜你的小精灵，获得 {{配置经验值}} 经验！"
- 自动累加对应经验值
- 同步刷新主页面经验进度条

**挑战失败**：

- 提示："不要气馁，还是要继续加油哦"
- 获得少量经验值（如 2 经验）

##### 3.2.3.3 交互反馈

- 经验值变动实时同步至主页面
- 若触发升级，自动弹出进化动画

---

#### 3.2.4 经验值规则配置模块

**配置项**：

- 回答正确经验值（正整数）
- 回答失败经验值（正整数，需小于回答正确经验值）

**操作流程**：

1. 点击"修改经验值"按钮
2. 输入配置值
3. 保存后即时生效

**交互反馈**：

- 保存成功：提示"规则已更新"
- 输入错误：提示"请填写有效经验值"

**默认值**：

- 回答正确：5 经验
- 回答失败：2 经验

---

#### 3.2.5 异常处理

| 场景             | 处理方式                                                   |
| ---------------- | ---------------------------------------------------------- |
| 无学生数据       | 页面中央显示"没有学生数据，请先添加学生"，所有功能按钮置灰 |
| 未配置经验值规则 | 使用默认值（正确 5 经验，失败 2 经验）                     |

---

### 3.3 转盘抽奖页

#### 3.3.1 模块定位

积分消耗类互动工具，让学生通过消耗积分参与转盘抽奖，获得额外积分或实物奖励。采用转盘形式，增加期待感和趣味性。

---

#### 3.3.2 转盘展示模块

##### 3.3.2.1 转盘设计

**视觉设计**：

- 圆形转盘，中央有"开始抽奖"按钮
- 转盘分为多个扇形区域（默认 8 个，可配置 6-12 个）
- 每个扇形区域显示：
  - 奖品图标（emoji 或小图标）
  - 奖品名称
  - 背景色彩（自动循环使用彩虹色系）
- 转盘顶部有固定的指针（三角形箭头）
- 转盘外圈有彩色光圈装饰

**色彩方案**：

系统自动为转盘扇形分配彩虹色系，循环使用以下颜色：

| 序号 | 背景色   | 说明     |
| ---- | -------- | -------- |
| 1    | 红色渐变 | 热情活力 |
| 2    | 橙色渐变 | 温暖阳光 |
| 3    | 黄色渐变 | 明亮欢快 |
| 4    | 绿色渐变 | 清新自然 |
| 5    | 青色渐变 | 清凉舒适 |
| 6    | 蓝色渐变 | 梦幻神秘 |
| 7    | 紫色渐变 | 优雅浪漫 |
| 8    | 粉色渐变 | 温柔可爱 |

> **说明**：如果扇形数量超过8个，颜色会从第1个重新开始循环使用

**转盘布局示例**（8个扇形）：

```
           ▼ 指针
      ╭─────────────╮
     ╱  🎁  │  ✏️   ╲
    │ 奖品1 │ 奖品2 │
   ├───────┼───────┤
  │ 📚   │  中心  │ 🎨 │
  │奖品8  │ 按钮  │奖品3│
   ├───────┼───────┤
    │ 奖品7 │ 奖品4 │
     ╲  ⚽  │  🎵   ╱
      ╰─────────────╯
        奖品6  奖品5
```

---

#### 3.3.3 抽奖操作模块

##### 3.3.3.1 操作流程

1. 从下拉列表选择参与抽奖的学生
2. 学生信息卡片显示在转盘旁边（姓名、当前积分）
3. 点击转盘中央的"开始抽奖"按钮
4. 弹出确认框："抽奖将消耗 {{配置积分}} 积分，是否开始？"
5. 点击"确认"
6. 转盘开始旋转（动画效果）
7. 转盘逐渐减速
8. 指针指向最终奖品
9. 播放庆祝动画和音效
10. 弹出结果对话框："🎉 恭喜！{{学生姓名}} 抽中了 {{奖品}}！"
11. 积分自动扣除，结果记录到历史

##### 3.3.3.2 动画效果

**旋转阶段**：

| 阶段             | 时长    | 转速           | 效果描述                       |
| ---------------- | ------- | -------------- | ------------------------------ |
| **加速期** | 0.5秒   | 快速加速       | 转盘从静止加速到高速旋转       |
| **匀速期** | 2-3秒   | 高速匀速       | 转盘高速旋转，奖品区域模糊     |
| **减速期** | 1.5-2秒 | 逐渐减速       | 转盘慢慢减速，指针经过多个奖品 |
| **停止期** | 0.3秒   | 轻微回弹后停止 | 指针精准停在目标奖品区域       |

**特效细节**：

- 旋转时转盘外圈光芒闪烁
- 指针经过奖品区域时播放"滴答"音效
- 减速阶段每经过一个奖品，该区域高亮一次
- 停止时播放欢快的"叮～"提示音
- 中奖区域放大并闪烁 0.5 秒

##### 3.3.3.3 交互反馈

**抽奖前**：

- 悬停"开始抽奖"按钮时，按钮轻微放大并发光
- 积分不足时，按钮置灰并显示"积分不足"提示

**抽奖中**：

- "开始抽奖"按钮变为"抽奖中..."并置灰
- 禁止重复点击
- 显示加载状态

**抽奖后**：

- 积分消耗实时同步至主页面
- 弹出结果对话框，显示奖品详情
- 按钮恢复可用状态
- 支持连续抽奖（积分足够的情况下）

##### 3.3.3.4 约束条件

- 转盘扇形数量可配置（建议 6-12 个）
- 每次抽奖消耗积分可在系统配置中自定义（默认 1 积分）
- 所有奖品中奖概率完全相同（均等概率，确保公平性）
- 转盘旋转动画总时长约 4-5.5 秒

> **公平性说明**：系统采用均等概率算法，每个奖品被抽中的概率完全相同（中奖概率 = 1 ÷ 奖品数量）。例如 8 个奖品时，每个奖品中奖概率为 12.5%

---

#### 3.3.4 抽奖配置模块

**配置项**：

- 每次抽奖消耗积分（正整数，默认 1 积分）
- 转盘扇形数量（6-12，默认 8）
- 奖品列表配置

**奖品配置详情**：

| 配置项             | 说明                             | 示例               |
| ------------------ | -------------------------------- | ------------------ |
| **奖品名称** | 奖品的显示名称                   | "文具套装"         |
| **奖品图标** | emoji 或图标名称                 | "✏️" 或 "pencil" |
| **库存数量** | 可兑换次数（可选，-1表示无限制） | 5 或 -1（无限制）  |

**操作流程**：

1. 点击"抽奖配置"按钮
2. 设置抽奖消耗积分
3. 设置转盘扇形数量
4. 添加/编辑奖品信息：
   - 奖品名称
   - 奖品图标
   - 库存数量（可选）
5. 保存后即时生效，转盘自动刷新

**交互约束**：

- 抽奖消耗积分需为正整数
- 转盘扇形数量需在 6-12 范围内
- 奖品数量必须等于扇形数量
- 奖品名称不可为空
- 库存数量为 -1 时表示无限制，否则必须为非负整数

**配置示例**（8个奖品）：

```
转盘扇形数量: 8
抽奖消耗积分: 1 积分

奖品列表:
1. 📝 文具套装      (库存: 5)
2. 📚 精美图书      (库存: 3)
3. 🎨 绘画工具      (库存: 4)
4. ⚽ 体育用品      (库存: 2)
5. 🎵 音乐礼品      (库存: -1，无限制)
6. 🌟 神秘大奖      (库存: 1)
7. 🎁 惊喜礼包      (库存: 6)
8. 🍬 小零食包      (库存: -1，无限制)

每个奖品中奖概率: 12.5% (均等概率)
```

---

#### 3.3.5 抽奖历史记录

**功能定位**：

记录学生的抽奖历史，便于教师查看和管理。

**记录管理规则**：

- 每个学生保留最近 15 条抽奖记录
- 超过 15 条时，自动删除最早的记录
- 确保历史记录不占用过多存储空间

**显示内容**：

- 学生姓名
- 抽奖时间
- 消耗积分
- 中奖奖品
- 奖品图标

**筛选功能**：

- 按学生筛选
- 按时间范围筛选
- 按奖品筛选

**操作功能**：

- 导出抽奖记录（Excel格式）
- 清空历史记录（需二次确认）

**历史记录示例**：

| 学生姓名 | 抽奖时间            | 消耗积分 | 中奖奖品    |
| -------- | ------------------- | -------- | ----------- |
| 张三     | 2025-11-08 10:30:25 | 1 积分   | 📝 文具套装 |
| 李四     | 2025-11-08 10:32:10 | 1 积分   | 🎨 绘画工具 |
| 王五     | 2025-11-08 10:35:48 | 1 积分   | 🌟 神秘大奖 |

---

#### 3.3.6 异常处理

| 场景                 | 处理方式                                                               |
| -------------------- | ---------------------------------------------------------------------- |
| 无学生数据           | 显示"没有学生数据，请先添加学生"，功能按钮置灰                         |
| 学生积分不足         | 下拉列表中姓名置灰并标注"积分不足"（不足配置的抽奖消耗积分），无法选择 |
| 奖品数量与扇形不匹配 | 保存配置时提示"奖品数量必须等于转盘扇形数量"，阻止保存                 |
| 所有奖品库存耗尽     | 抽奖按钮置灰，提示"奖品已全部兑完，请等待补充"                         |

**库存处理规则**：

1. **抽奖前检查**：

   - 系统自动过滤库存为 0 的奖品
   - 仅从有效奖品池（库存 > 0 或库存为 -1 无限制）中随机抽取
   - 若所有奖品库存为 0，则抽奖按钮置灰，提示"奖品已全部兑完，请等待补充"
2. **抽奖与扣除**：

   - 从有效奖品池中随机抽取一个奖品
   - 自动扣除学生积分
   - 显示中奖结果
3. **库存更新**：

   - 成功抽中奖品后，若库存不为 -1（无限制），则库存数量 -1
   - 若库存减为 0，下次抽奖前自动从有效奖品池中排除该奖品
4. **库存补充**：

   - 教师可在"抽奖配置"中随时补充奖品库存
   - 库存补充后，若之前所有奖品库存为 0，抽奖按钮自动恢复可用状态

---

### 3.4 声音互动页

#### 3.4.1 模块定位

朗读/自习场景互动工具，通过可爱动画角色可视化激励学生，提升课堂氛围。

---

#### 3.4.2 模式选择模块

**模式类型**：

| 模式               | 说明         | 角色行为                          |
| ------------------ | ------------ | --------------------------------- |
| **读书模式** | 鼓励大声朗读 | 声音越大，角色跳跃/飞舞越高       |
| **自习模式** | 鼓励安静学习 | 保持低音量，角色展示安静/思考动作 |

**交互反馈**：

- 切换模式后，页面提示语同步更新
- 读书模式提示："开始朗读吧！声音越大，小星星跳得越高"
- 自习模式提示："保持安静，让小精灵安心思考"

---

#### 3.4.3 声音检测与校准模块

##### 3.4.3.1 权限申请

**首次使用流程**：

1. 弹出"需要麦克风权限"提示
2. 引导教师允许浏览器访问麦克风
3. 权限拒绝时，功能按钮置灰，提示"请允许麦克风权限后使用"

##### 3.4.3.2 音量校准

**校准流程**：

1. 点击"音量校准"按钮
2. 系统提示："以正常读书音量朗读"
3. 点击"开始校准"
4. 系统记录基准音量
5. 显示"当前音量 0%"逐步更新为基准值
6. 角色伴随校准过程做欢快的准备动作

**说明**：

- 音量校准仅需首次使用时操作
- 后续可直接使用，也可重新校准

##### 3.4.3.3 实时检测

**音量与角色行为映射**：

| 音量等级           | 音量范围 | 角色行为                 |
| ------------------ | -------- | ------------------------ |
| **低音量**   | 0-30%    | 轻轻摇晃或微笑           |
| **中等音量** | 31-70%   | 愉快地跳跃或旋转         |
| **高音量**   | 71-100%  | 兴奋地飞舞或做出胜利姿势 |

**特效触发**：

- 达到特定音量阈值时，触发额外小特效
- 例如：星星闪烁、爱心出现、小动物发出可爱音效

**页面显示**：

- 实时显示"当前音量 X%"
- 角色根据音量变化改变表情和颜色

---

#### 3.4.4 设计规范

**角色设计原则**：

- ✅ 造型可爱、色彩鲜明、线条简单
- ✅ 动作节奏舒缓，适合小学生认知特点
- ✅ 视觉风格积极向上、富有童趣
- ✅ 互动效果直观且有趣

---

#### 3.4.5 约束条件

- 麦克风权限为核心依赖，无权限则无法使用该功能
- 音量校准仅需首次使用时操作，后续可直接使用

---

### 3.5 积分商店页

#### 3.5.1 模块定位

积分兑换工具，让学生用积累的积分兑换实物/虚拟奖励，实现积分价值闭环。

---

#### 3.5.2 兑换操作模块

##### 3.5.2.1 操作流程

1. 从下拉列表选择学生（显示当前积分）
2. 浏览可兑换商品列表
   - 仅显示学生积分 ≥ 商品所需积分的商品
   - 积分不足的商品置灰，标注"积分不足"
3. 点击目标商品
4. 弹出确认框："确定要兑换此商品吗？"
5. 点击"确认"
6. 弹出结果："🎉 兑换成功！已成功兑换 {{商品名称}}！"

##### 3.5.2.2 交互反馈

- 兑换后学生积分实时扣除对应数值
- 若商品有库存限制，兑换后库存 -1
- 库存减为 0 的商品自动从商品列表移除（不再显示）
- 积分变动实时同步至主页面

---

#### 3.5.3 商品配置模块

**配置项**：

- 商品名称
- 所需积分
- 商品库存（可选）

**操作流程**：

1. 点击"商品配置"按钮
2. 添加/编辑商品信息
3. 保存后即时生效

**交互约束**：

- 商品所需积分需为正整数
- 支持删除商品，但至少保留 1 个商品
- 商品名称不可为空

---

#### 3.5.4 异常处理

| 场景         | 处理方式                                       |
| ------------ | ---------------------------------------------- |
| 无学生数据   | 显示"没有学生数据，请先添加学生"，功能按钮置灰 |
| 学生积分不足 | 对应商品置灰，标注"积分不足"，无法点击兑换     |

---

### 3.6 成绩管理页

#### 3.6.1 模块定位

集中管理学生成绩数据，支持批量导入和手动录入，自动换算经验值。

---

#### 3.6.2 整体布局

```
┌─────────────────────────────────────────────────────┐
│ [成绩管理页]                    [⚙️ 换算规则配置]    │
├───────────────┬─────────────────────────────────────┤
│               │ 📋 学生信息概览                      │
│   学生列表     │  ├─ 姓名、积分、经验值               │
│   (支持搜索)   │  └─ 精灵展示卡片                    │
│               ├─────────────────────────────────────┤
│   [学生A]     │ 📝 成绩录入功能区                    │
│   [学生B]     │  ├─ 科目选择                        │
│   [学生C]     │  ├─ 成绩输入                        │
│   ...         │  └─ [确认提交] 按钮                 │
│               ├─────────────────────────────────────┤
│               │ 📦 批量导入功能区                    │
│               │  ├─ [下载模板] 按钮                 │
│               │  ├─ 文件选择器                      │
│               │  ├─ [上传文件] 按钮                 │
│               │  └─ [确认导入] 按钮                 │
│               ├─────────────────────────────────────┤
│               │ 📊 成绩历史记录                      │
│               │  ├─ 筛选选项 (科目、时间范围)        │
│               │  └─ 成绩列表 (科目/成绩/时间/经验值)  │
└───────────────┴─────────────────────────────────────┘
```

---

#### 3.6.3 学生选择模块

**功能详情**：

- 显示班级所有学生列表
- 支持实时搜索学生姓名
- 支持按积分/经验值排序

**交互反馈**：

- 选择学生后，右侧所有模块自动更新对应学生数据

---

#### 3.6.4 精灵预览模块

**信息展示**：

- 精灵形象（大图展示）
- 精灵品种
- 当前等级
- 进化阶段
- 经验值进度条
- 已获得经验值 / 下一阶段所需经验值

**交互反馈**：

- 精灵图片支持点击放大查看
- 悬停显示精灵详细信息

---

#### 3.6.5 手动成绩录入模块

##### 3.6.5.1 表单字段

| 字段               | 类型       | 约束  | 说明                           |
| ------------------ | ---------- | ----- | ------------------------------ |
| **科目选择** | 下拉列表   | 必填  | 支持所有已配置的科目           |
| **成绩输入** | 数字输入框 | 0-100 | 实时验证，超出范围显示红色警告 |

**说明**：

- 录入时间自动记录为当前操作时间
- 支持快速连续录入（提交后自动清空成绩输入框，保留科目选择）

##### 3.6.5.2 操作流程

1. 选择学生（左侧学生列表）
2. 选择科目（下拉列表）
3. 输入成绩（0-100 的数字）
4. 点击"确认提交"按钮
5. 系统自动：
   - 记录当前时间为录入时间
   - 按配置规则换算为经验值并累加
   - 保存成绩记录到历史列表
6. 表单自动清空成绩输入框，可继续录入下一科目

##### 3.6.5.3 交互反馈

- 填写表单时提供实时验证提示
- 成绩超出范围显示红色警告："成绩必须在 0-100 范围内"
- 录入成功后：
  - 弹出"录入成功"提示
  - 显示获得的经验值（如"获得 15 经验值"）
  - 成绩历史列表实时更新
  - 经验值和进度条同步更新
- 若触发精灵进化，自动弹出进化动画

---

#### 3.6.6 批量导入成绩模块

##### 3.6.6.1 模板下载

**模板格式**：Excel (.xlsx)

**模板结构**：横向科目列格式

| 姓名 | 语文 | 数学 | 英语 | 音乐 | 体育 | 美术 | ... |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | --- |
| 张三 | 85   | 90   | 78   | 92   | 88   | 95   | ... |
| 李四 | 92   | 88   | 95   | 85   | 90   | 87   | ... |
| 王五 | 78   | 85   | 88   | 90   | 92   | 89   | ... |

**字段说明**：

| 列类型           | 说明                                       | 必填 |
| ---------------- | ------------------------------------------ | ---- |
| **姓名列** | 第一列，必须与系统中学生姓名完全匹配       | ✅   |
| **科目列** | 从第二列开始，每个科目占一列，列名为科目名 | ✅   |
| **成绩值** | 0-100 范围内的数字，允许为空               | ❌   |

**模板特性**：

- **自动识别科目**：系统根据表头自动识别科目列
- **灵活性**：教师可自定义包含哪些科目，不需要的科目可不包含
- **空值处理**：单元格为空表示该学生该科目未参加考试，不录入成绩
- **导入时间**：批量导入的成绩录入时间统一为导入操作的时间

**模板示例说明**：

```
第一列：姓名（必填）
第二列起：各科目名称作为列标题
单元格：填写对应成绩（0-100），未考试的留空
```

##### 3.6.6.2 导入流程

1. 点击"下载模板"按钮，下载标准模板
   - 模板自动包含系统中已配置的所有科目
   - 包含示例数据行供参考
2. 填写 Excel 文件
   - 在姓名列下方填写学生姓名
   - 在对应科目列填写成绩
   - 未参加考试的留空即可
3. 点击"选择文件"，选择填写好的 Excel 文件
4. 点击"上传文件"
5. 系统显示预览表格：
   - 展示Excel文件中的原始数据（姓名、各科目成绩）
   - 数据有效性标识：
     - ✅ 绿色：学生姓名存在且成绩有效
     - ⚠️ 黄色：学生姓名不存在
     - ❌ 红色：成绩超出范围（非0-100）
   - 显示统计信息：
     - 总记录数：X 条
     - 有效记录：Y 条
     - 异常记录：Z 条
6. 确认无误后点击"确认导入"
7. 系统显示导入进度条和实时统计（成功数量/失败数量）
8. 导入完成后显示详细报告

##### 3.6.6.3 进度反馈

**导入中**：

- 显示进度条（按学生数量计算进度）
- 实时统计：
  - 已处理学生数：X / 总数
  - 成功录入成绩条数：Y 条
  - 失败记录数：Z 条
- 按钮置灰，禁止重复操作

**导入完成**：

- 显示详细报告：
  - ✅ **成功导入学生数**：X 名
  - ✅ **成功录入成绩条数**：Y 条
  - ✅ **总计获得经验值**：Z 经验
  - ❌ **失败学生列表**：姓名、原因（如"学生不存在"）
  - ⚠️ **数据问题列表**：学生姓名、科目、问题描述（如"成绩超出范围"）
  - ℹ️ **忽略的科目**：未配置的科目列表
- 按钮恢复可用状态
- 成绩历史列表实时更新
- 学生经验值和进度条同步更新
- 若有学生触发进化，显示提示"X 名学生达到进化条件"

**重复成绩处理**：

- 同一学生同一科目允许多次成绩记录（追加模式）
- 所有成绩记录保留在成绩历史列表中
- 每次录入均独立计算经验值并累加
- 成绩历史查看时按时间倒序显示所有记录

---

#### 3.6.7 成绩历史查看模块

##### 3.6.7.1 历史成绩列表

**记录管理规则**：

- 每个学生保留最近 15 条成绩记录
- 超过 15 条时，自动删除最早的记录
- 确保历史记录不占用过多存储空间

**显示字段**：

- 科目
- 成绩
- 录入时间
- 获得经验值

**筛选功能**：

- 按科目筛选（支持多选）
- 按时间范围筛选（开始日期 - 结束日期）

**排序功能**：

- 按录入时间排序（默认）
- 按成绩排序
- 按获得经验值排序

##### 3.6.7.2 交互反馈

- 数据加载时显示加载动画
- 筛选条件变更后实时刷新列表

---

#### 3.6.8 异常处理

##### 3.6.8.1 成绩导入异常

| 异常类型                 | 异常情况                       | 处理方式                                         |
| ------------------------ | ------------------------------ | ------------------------------------------------ |
| **文件格式错误**   | 非 .xlsx 文件                  | 拒绝上传，提示"文件格式错误，请使用 Excel 文件"  |
| **模板结构错误**   | 缺少"姓名"列                   | 拒绝上传，提示"模板格式错误，请使用标准模板"     |
| **学生姓名不存在** | 学生姓名不在系统中             | 跳过该学生，在失败明细中标注"学生不存在"         |
| **成绩格式错误**   | 成绩非数字（如文字、特殊字符） | 该单元格标红，提示"成绩必须为 0-100 的数字"      |
| **成绩超出范围**   | 成绩 < 0 或 > 100              | 该单元格标红，提示"成绩必须在 0-100 范围内"      |
| **科目不存在**     | 表头科目名不在系统配置中       | 自动忽略该列，在导入报告中提示"已忽略未配置科目" |

**处理原则**：

- 异常数据单独记录，不影响整体导入
- 导入预览时标识异常单元格（红色/黄色高亮）
- 导入完成后以表格形式清晰列出：
  - 成功：学生姓名、导入科目数、获得经验值
  - 失败：学生姓名、行号、错误原因
- 显示汇总报告：
  - 成功导入学生数量
  - 成功录入成绩条数
  - 失败学生数量及明细
  - 忽略的未配置科目列表

##### 3.6.8.2 手动录入错误

| 错误类型            | 处理方式                               |
| ------------------- | -------------------------------------- |
| 成绩超出 0-100 范围 | 输入框旁显示红色错误提示，阻止表单提交 |
| 成绩非数字          | 提示"请输入有效的数字"，阻止表单提交   |
| 科目未选择          | 提示"请选择科目"，阻止表单提交         |
| 学生未选择          | 提示"请先选择学生"，阻止表单提交       |

##### 3.6.8.3 无学生数据

**场景**：系统中无任何学生数据

**处理方式**：

- 页面中央显示"没有学生数据，请先添加学生"
- 所有功能按钮置灰

---

#### 3.6.9 操作按钮

**页面主要操作区**：

- 刷新数据
- 换算规则配置（右上角）

**成绩录入功能区**：

- 科目选择下拉列表
- 成绩输入框
- 确认提交按钮

**批量导入功能区**：

- 下载模板按钮
- 文件选择器
- 上传文件按钮
- 确认导入按钮

**历史记录区域**：

- 筛选选项（科目、时间范围）
- 排序选项（时间、成绩、经验值）

---

#### 3.6.10 考试成绩换算规则配置模块

##### 3.6.10.1 模块定位

此配置模块专门用于设置考试成绩到经验值的换算规则，支持多科目差异化配置。

##### 3.6.10.2 配置项说明

**基础换算规则**：

| 配置项             | 说明                        | 默认值 | 范围    |
| ------------------ | --------------------------- | ------ | ------- |
| **基础分数** | 开始计算经验值的起始分数    | 60     | 0-100   |
| **基础经验** | 达到基础分数时获得的经验值  | 10     | 1-100   |
| **分数系数** | 每超过基础分数1分的经验增量 | 0.5    | 0.1-5.0 |

**经验值计算公式**：

```
经验值计算公式：
- 当分数 ≥ 基础分数时：经验值 = 基础经验 + (分数 - 基础分数) × 分数系数 × 科目比例
- 当分数 < 基础分数时：经验值 = 0（或按其他规则处理）
```

**计算示例**（按默认配置）：

| 成绩范围    | 计算过程                            | 结果                                |
| ----------- | ----------------------------------- | ----------------------------------- |
| 60-100 分   | 10 + (分数 - 60) × 0.5 × 科目比例 | 60分=10经验，每增加1分多获得0.5经验 |
| 满分 100 分 | 10 + (100 - 60) × 0.5 × 1.0       | 30 经验                             |

**多科目支持**：

| 科目类型         | 换算比例 | 示例科目                 | 说明                       |
| ---------------- | -------- | ------------------------ | -------------------------- |
| **主科**   | 1.0      | 语文、数学、英语         | 按标准公式计算             |
| **副科**   | 0.8      | 音乐、美术、体育         | 经验值为主科的80%          |
| **自定义** | 可调整   | 支持自定义科目及对应比例 | 教师可根据实际需求灵活设置 |

##### 3.6.10.3 科目管理

**科目列表配置**：

换算规则配置模块中包含科目管理功能，用于添加、编辑、删除科目。

**操作流程**：

1. 在换算规则配置对话框中，查看"科目列表"区域
2. 点击"添加科目"按钮
3. 填写科目信息：
   - 科目名称（必填，如"语文"、"数学"）
   - 换算比例（必填，默认 1.0）
4. 点击"保存"
5. 科目添加成功后，立即可在成绩录入的科目下拉列表中使用

**编辑科目**：

1. 在科目列表中点击目标科目的"编辑"按钮
2. 修改科目名称或换算比例
3. 点击"保存"
4. 修改后的科目信息即时生效（仅影响后续录入的成绩）

**删除科目**：

1. 在科目列表中点击目标科目的"删除"按钮
2. 弹出确认对话框："确定要删除科目 {{科目名称}} 吗？已录入的历史成绩不受影响。"
3. 点击"确认"
4. 科目从列表中移除，后续成绩录入时不再显示该科目

**默认科目**：

系统首次使用时，自动预置以下科目：

| 科目名称 | 换算比例 | 类型 |
| -------- | -------- | ---- |
| 语文     | 1.0      | 主科 |
| 数学     | 1.0      | 主科 |
| 英语     | 1.0      | 主科 |
| 音乐     | 0.8      | 副科 |
| 美术     | 0.8      | 副科 |
| 体育     | 0.8      | 副科 |

教师可根据实际需求自由添加、修改或删除科目。

**科目与成绩录入的关系**：

- 成绩录入（主页面快速录入、成绩管理页手动录入）的科目下拉列表，来源于此处配置的科目列表
- 批量导入成绩时，表头科目名称需与此处配置的科目名称完全匹配
- 若导入的科目不在配置列表中，系统会自动忽略该列，并在导入报告中提示

##### 3.6.10.4 操作流程

1. 点击成绩管理页右上角的"换算规则配置"按钮
2. 设置基础分数、基础经验、分数系数
3. 管理科目列表（添加/编辑/删除科目及对应换算比例）
4. 保存后即时生效

##### 3.6.10.5 交互反馈

- 配置修改后即时生效，影响后续成绩录入的经验值计算
- 已录入的历史成绩不受影响
- 保存成功后提示"换算规则已更新"
- 修改规则时显示"此操作仅影响后续录入的成绩"提示
- 科目添加成功后提示"科目已添加"
- 科目删除成功后提示"科目已删除"

##### 3.6.10.6 交互约束

- 基础分数必须在 0-100 范围内
- 分数系数必须为正数
- 科目名称不可为空
- 科目名称不可重复
- 科目比例必须为正数（建议范围：0.1-2.0）
- 至少保留 1 个科目（不允许删除所有科目）

---

#### 3.6.11 约束条件

| 约束项               | 约束规则                                              |
| -------------------- | ----------------------------------------------------- |
| **数据有效性** | 成绩必须在 0-100 分范围内，必须为数字                 |
| **文件格式**   | 导入文件仅支持 .xlsx 格式                             |
| **模板结构**   | 必须包含"姓名"列，科目列从第二列开始                  |
| **时间记录**   | 成绩录入时间自动记录为操作时间，不可手动修改          |
| **操作权限**   | 关键操作（如删除学生、清空成绩）需二次确认            |
| **导入限制**   | 单次导入文件大小不超过 10MB，最多支持 1000 行学生数据 |

---

## 四、非功能性需求

### 4.1 兼容性

**浏览器兼容性**：

- 支持主流浏览器：Chrome、Edge、Safari、Firefox
- 版本要求：近 3 个迭代版本

**设备兼容性**：

- PC端（Windows、macOS）

---

### 4.2 性能

| 性能指标               | 要求                            |
| ---------------------- | ------------------------------- |
| **页面加载时间** | ≤ 2 秒                         |
| **操作反馈时间** | ≤ 1 秒（积分更新、抽奖结果等） |
| **批量导入性能** | 1000 条数据导入时间 ≤ 10 秒    |
| **动画帧率**     | ≥ 30 FPS                       |

---

### 4.3 安全性

**数据安全**：

- 学生数据仅支持教师手动导出，无后台自动上传
- 导出数据支持加密（可选）

**权限管理**：

- 关键操作（如删除学生）需二次确认

---

### 4.4 易用性

**操作便捷性**：

- ✅ 所有配置项修改后即时生效，无需刷新页面
- ✅ 关键操作（如删除学生）需二次确认
- ✅ 关键批量操作支持撤销/重做功能，提升操作容错性

**用户体验**：

- 清晰的错误提示
- 友好的交互反馈
- 直观的操作流程

---

### 4.5 数据备份与恢复

#### 4.5.1 备份频率

| 备份类型           | 频率       | 说明                         |
| ------------------ | ---------- | ---------------------------- |
| **自动备份** | 每 24 小时 | 系统自动执行一次完整备份     |
| **手动备份** | 随时       | 教师可通过"备份数据"按钮触发 |

#### 4.5.2 备份方式

**自动备份**：

- **存储位置**：浏览器本地存储（IndexedDB）
- **存储格式**：JSON 格式（明文）
- **备份命名**：`AutoBackup_YYYYMMDD_HHmmss`
- **保留数量**：最近 5 次自动备份
- **访问方式**：通过"备份管理"页面查看和恢复
- **清理机制**：超过 5 次时，自动删除最早的备份

**手动备份**：

- **存储位置**：下载到教师本地设备
- **文件格式**：JSON 格式（可选加密）
- **文件命名**：`ClassroomBackup_YYYYMMDD_HHmmss.json`
- **保留数量**：无限制（由教师自行管理）
- **访问方式**：通过文件系统访问

---

**备份内容**：

**学生数据（完整备份）**：

- 学生唯一标识（studentId）
- 学生基本信息（姓名、学号）
- 精灵信息（精灵品种、进化阶段）
- 积分数据（当前积分、最近15条积分历史记录）
- 经验值数据（当前经验值、最近15条经验值历史记录）
- 成绩数据（最近15条成绩记录）
- 时间戳（创建时间、最后更新时间）

**系统配置（完整备份）**：

- 展示设置（卡片数、排序方式）
- 精灵进化规则（等级阈值、升级奖励）
- 随机点名规则（正确/错误经验值）
- 成绩换算规则（基础分数、系数、科目列表）
- 转盘抽奖配置（消耗积分、扇形数量、奖品列表）
- 积分商店配置（商品列表）

**不备份的数据**：

- 操作记录（撤销/重做记录，恢复后自动清空）
- 抽奖历史记录（非核心数据，可选备份）
- 兑换历史记录（非核心数据，可选备份）

---

**历史版本管理**：

- 自动备份：系统最多保留最近 5 次
- 手动备份：无限制（由教师自行管理本地文件）
- 支持在"备份管理"页面查看自动备份列表及创建时间

#### 4.5.3 恢复机制

**恢复流程**：

1. 点击"恢复数据"按钮
2. 选择恢复来源：
   - 从自动备份恢复（选择备份记录）
   - 从本地文件恢复（上传备份文件）
3. 系统验证文件有效性（格式、完整性、兼容性）
4. 显示备份数据摘要（包含备份时间、学生数量、数据项统计）
5. **自动创建当前数据的临时备份**（见"恢复前保护机制"）
6. 教师确认后执行恢复
7. 恢复完成后自动刷新页面数据
8. 显示"数据恢复成功"提示

**数据验证**：

- 文件格式验证（JSON 格式）
- 数据完整性验证（必填字段检查）
- 版本兼容性验证（检查数据结构版本）
- 数据项验证：
  - 学生数据必须包含：studentId、name、points、experience
  - 系统配置必须包含：display、experience、lottery、store

**恢复来源说明**：

| 恢复来源           | 说明                             | 使用场景                     |
| ------------------ | -------------------------------- | ---------------------------- |
| **自动备份** | 从浏览器本地存储的自动备份中恢复 | 误操作后快速回滚（最近5次） |
| **本地文件** | 从教师手动备份的文件中恢复       | 跨设备恢复、长期备份恢复     |

**版本提示**：

- 显示备份文件的创建时间
- 显示备份文件的版本信息
- 显示备份文件包含的数据项统计：
  - 学生数量
  - 系统配置项数量
  - 备份文件大小

**恢复后处理**：

- **成功**：
  - 自动刷新页面数据
  - 提示"数据恢复成功，已从 {{备份时间}} 的备份恢复"
  - 临时备份保留24小时
  - 清空操作记录（撤销/重做记录）
- **失败**：
  - 显示具体错误原因（如"文件格式错误"、"数据不完整"、"版本不兼容"）
  - 提示"是否恢复到临时备份状态"
  - 保持当前数据不变

---

**恢复前保护机制**：

执行数据恢复前，系统会自动创建当前数据的临时备份：

- **临时备份名称**：`TempBackup_BeforeRestore_YYYYMMDD_HHmmss`
- **存储位置**：浏览器本地存储（IndexedDB）
- **保留时长**：24小时后自动删除
- **访问方式**：恢复失败时，系统提示"是否恢复到临时备份状态"，可一键恢复
- **显示提示**："已创建临时备份，如恢复失败可在24小时内回滚"

**临时备份使用场景**：

| 场景                 | 处理方式                                                 |
| -------------------- | -------------------------------------------------------- |
| 恢复成功             | 临时备份保留24小时，教师可选择删除或保留                 |
| 恢复失败（文件损坏） | 系统提示"恢复失败，是否恢复到临时备份"，点击"确认"可回滚 |
| 恢复后发现数据错误   | 教师可在"备份管理"页面查看临时备份，选择"恢复临时备份"   |
| 24小时后             | 临时备份自动删除，不占用存储空间                         |

#### 4.5.4 备份管理页面

**功能定位**：

集中管理自动备份、临时备份，提供查看、恢复、删除功能。

**页面元素**：

**自动备份列表**：

- 显示最近 5 次自动备份
- 列表字段：备份时间、学生数量、文件大小、操作按钮
- 操作按钮：查看详情、恢复、删除

**临时备份列表**：

- 显示所有未过期的临时备份
- 列表字段：创建时间、剩余有效时间、学生数量、操作按钮
- 操作按钮：查看详情、恢复、删除、延长有效期（+24小时）

**手动备份区域**：

- "创建备份"按钮：立即备份当前数据并下载
- "从文件恢复"按钮：上传本地备份文件并恢复

**操作日志**：

- 显示最近 10 条备份/恢复操作记录
- 记录内容：操作类型、操作时间、操作结果、备份名称

#### 4.5.5 注意事项

⚠️ **重要提示**：

- 恢复操作将**覆盖当前所有数据**，请谨慎操作
- 系统会在恢复前自动创建临时备份，恢复失败可在24小时内回滚
- 建议教师定期将手动备份文件存储到云端或其他安全位置，防止设备故障导致数据丢失
- 自动备份仅保留在浏览器本地存储，清除浏览器数据会导致自动备份丢失
- 临时备份仅保留24小时，过期自动删除

---

## 五、数据模型与流转

### 5.1 核心数据模型

#### 5.1.1 学生数据模型

```json
{
  "studentId": "string (唯一标识, UUID v4 格式, 示例: a3f2e1b0-5c8d-4e6f-9a7b-1c2d3e4f5g6h)",
  "name": "string (学生姓名, 自动去除前后空格)",
  "studentNumber": "string (学号, 可选)",
  "points": {
    "current": "number (当前积分)",
    "history": [
      {
        "type": "string (操作类型: reward_manual=教师手动奖励 | reward_evolution=精灵进化奖励 | reward_activity=课堂互动奖励 | consume_lottery=转盘抽奖消耗 | consume_store=积分商店兑换消耗)",
        "change": "number (积分变化, 正数=增加, 负数=消耗)",
        "reason": "string (操作原因)",
        "relatedId": "string (关联ID, 如抽奖记录ID、商品ID, 可选)",
        "timestamp": "datetime (操作时间)",
        "operator": "string (操作者: teacher=教师 | system=系统)"
      }
    ],
    "note": "保留最近15条积分历史记录，超过自动删除最早记录"
  },
  "experience": {
    "current": "number (当前经验值)",
    "petSpecies": "string (精灵品种: '星尘神兽'|'灵鹿神兽'|'彩雾神兽')",
    "evolutionStage": "number (进化阶段, 1-9)",
    "history": [
      {
        "gain": "number (获得经验值)",
        "source": "string (来源: 点名/成绩/其他)",
        "timestamp": "datetime (获得时间)"
      }
    ],
    "note": "保留最近15条经验值历史记录，超过自动删除最早记录"
  },
  "grades": [
    {
      "subject": "string (科目)",
      "score": "number (成绩, 0-100)",
      "experienceGained": "number (换算经验值)",
      "recordTime": "datetime (录入时间)"
    }
  ],
  "gradesNote": "每个学生保留最近15条成绩记录，超过自动删除最早记录",
  "createdAt": "datetime (创建时间)",
  "updatedAt": "datetime (最后更新时间)"
}
```

#### 5.1.2 系统配置模型

```json
{
  "display": {
    "cardsPerRow": "number (一行卡片数, 3-12)",
    "sortBy": "string (排序方式: points/experience)"
  },
  "experience": {
    "levelThresholds": [
      {
        "level": "number (等级编号, 1-9)",
        "stageName": "string (阶段名称)",
        "requiredExp": "number (累计所需经验值)",
        "reward": "number (升级奖励积分)",
        "description": "string (阶段描述)"
      }
    ],
    "activities": {
      "answerCorrect": "number (回答正确经验值)",
      "answerWrong": "number (回答错误经验值)"
    },
    "examConversion": {
      "baseScore": "number (基础分数, 默认60)",
      "baseExperience": "number (基础经验, 默认10)",
      "scoreCoefficient": "number (分数系数, 默认0.5)",
      "subjects": [
        {
          "name": "string (科目名称)",
          "ratio": "number (换算比例, 默认1.0)"
        }
      ]
    }
  },
  "lottery": {
    "costPerDraw": "number (每次抽奖消耗积分, 默认1)",
    "wheelSections": "number (转盘扇形数量, 6-12, 默认8)",
    "prizes": [
      {
        "name": "string (奖品名称)",
        "icon": "string (奖品图标, emoji或图标名称)",
        "stock": "number (库存数量, -1表示无限制)"
      }
    ]
  },
  "store": {
    "products": [
      {
        "id": "string (商品ID)",
        "name": "string (商品名称)",
        "cost": "number (所需积分)",
        "stock": "number (库存数量, 可选)"
      }
    ]
  }
}
```

#### 5.1.3 操作记录模型

```json
{
  "operationId": "string (操作ID)",
  "type": "string (操作类型: batchPointsReward/batchExperienceReward/batchDelete/batchImport)",
  "operator": "string (操作者)",
  "timestamp": "datetime (操作时间)",
  "affectedStudents": ["array of studentIds"],
  "beforeState": "object (操作前状态)",
  "afterState": "object (操作后状态)",
  "note": "系统保留最近15条操作记录，超过自动删除最早记录"
}
```

---

### 5.2 数据流转图

```
┌─────────────────────────────────────────────────────┐
│                   课堂互动活动                        │
│  (点名、回答问题、朗读练习等)                         │
└──────────────────┬──────────────────────────────────┘
                   │
                   ↓ 产生经验值
┌─────────────────────────────────────────────────────┐
│                  学生经验值池                         │
│  ├─ 累计经验值                                       │
│  └─ 达到升级阈值 → 触发精灵进化                       │
└──────────────────┬──────────────────────────────────┘
                   │
                   ↓ 进化奖励积分
┌─────────────────────────────────────────────────────┐
│                  学生积分池                           │
│  ├─ 课堂互动奖励                                     │
│  ├─ 精灵进化奖励                                     │
│  └─ 教师手动奖励积分                                  │
└──────────────────┬──────────────────────────────────┘
                   │
                   ↓ 积分消耗
┌─────────────────────────────────────────────────────┐
│              积分消耗场景                             │
│  ├─ 转盘抽奖 (消耗积分可配置)                        │
│  └─ 积分商店兑换 (按商品价格消耗)                     │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│                  考试成绩录入                         │
│  (手动录入 / 批量导入)                               │
└──────────────────┬──────────────────────────────────┘
                   │
                   ↓ 按配置规则换算
┌─────────────────────────────────────────────────────┐
│                  经验值计算                           │
│  公式: 基础经验 + (分数 - 基础分数) × 系数 × 科目比例 │
└──────────────────┬──────────────────────────────────┘
                   │
                   ↓ 累加到学生经验值池
┌─────────────────────────────────────────────────────┐
│                  学生经验值池                         │
│  (同上)                                              │
└─────────────────────────────────────────────────────┘
```

---

### 5.3 数据同步规则

**全局数据共享原则**：

- ✅ 学生核心数据（姓名、积分、经验值、精灵信息）在所有页面共享
- ✅ 一处修改，全局同步
- ✅ 数据变动实时反映到所有相关界面

**数据更新触发点**：

| 操作       | 触发更新                                 |
| ---------- | ---------------------------------------- |
| 积分奖励   | 学生卡片积分、积分历史                   |
| 经验值奖励 | 学生卡片经验进度条、精灵阶段             |
| 成绩录入   | 成绩历史列表、学生经验值、经验进度条     |
| 精灵进化   | 学生卡片精灵形象、精灵阶段、积分（奖励） |
| 抽奖/兑换  | 学生积分                                 |

---

### 5.4 数据同步技术实现

#### 5.4.1 技术方案

**推荐方案**：全局状态管理 + 事件驱动机制

**技术选型**：

| 前端框架 | 推荐状态管理方案 | 说明                               |
| -------- | ---------------- | ---------------------------------- |
| React    | Redux / Zustand  | Redux 适合大型项目，Zustand 轻量级 |
| Vue      | Vuex / Pinia     | Pinia 是 Vue 3 推荐方案            |
| Angular  | NgRx             | 基于 RxJS 的状态管理               |

#### 5.4.2 数据同步机制

**单一数据源（Single Source of Truth）**：

- 所有学生数据存储在全局状态管理器中
- 所有页面/组件从全局状态读取数据
- 任何数据修改都通过全局状态管理器的 action/mutation 进行

**数据更新流程**：

```
用户操作 → 触发 Action → 更新全局状态 → 自动通知所有订阅组件 → 组件重新渲染
```

**示例（React + Redux）**：

```javascript
// 1. 用户在主页面奖励积分
dispatch(addPoints({ studentId: '001', points: 10, reason: '课堂表现优秀' }));

// 2. Redux 更新全局状态
// state.students[0].points.current += 10

// 3. 所有订阅该学生数据的组件自动更新：
//    - 主页面学生卡片显示新积分
//    - 转盘抽奖页学生信息卡片显示新积分
//    - 积分商店页学生积分显示更新
```

#### 5.4.3 跨页面数据同步

**同一浏览器标签页内**：

- 通过全局状态管理器自动同步
- 页面切换时保持状态不丢失

**多标签页同步（可选功能）**：

若需要支持多标签页同时打开并保持数据同步，可采用以下方案：

| 方案                        | 说明                                | 优点             | 缺点                 |
| --------------------------- | ----------------------------------- | ---------------- | -------------------- |
| **LocalStorage 事件** | 监听 `storage` 事件，标签页间通信 | 实现简单         | 仅支持同源标签页     |
| **BroadcastChannel**  | 浏览器原生 API，标签页间广播消息    | 性能好，API 简洁 | 部分旧浏览器不支持   |
| **SharedWorker**      | 共享 Worker 线程，标签页共享数据    | 功能强大         | 实现复杂，兼容性一般 |

**推荐方案**：BroadcastChannel（适合现代浏览器）

```javascript
// 标签页 A：数据修改后广播
const channel = new BroadcastChannel('classroom_sync');
channel.postMessage({ type: 'UPDATE_POINTS', studentId: '001', points: 10 });

// 标签页 B：监听并更新本地状态
channel.onmessage = (event) => {
  if (event.data.type === 'UPDATE_POINTS') {
    dispatch(updatePointsFromSync(event.data));
  }
};
```

#### 5.4.4 数据持久化

**本地存储**：

- 使用 `localStorage` 或 `IndexedDB` 存储学生数据
- 页面刷新后自动恢复数据
- 定期自动保存（每次数据变更后）

**自动保存机制**：

```javascript
// 监听全局状态变化，自动保存到 localStorage
store.subscribe(() => {
  const state = store.getState();
  localStorage.setItem('classroom_data', JSON.stringify(state));
});
```

#### 5.4.5 性能优化

**数据更新优化**：

- 使用 `React.memo` / `Vue computed` 避免不必要的重新渲染
- 仅订阅需要的数据，避免全局订阅
- 批量更新：多个数据变更合并为一次状态更新

**大数据量优化**：

- 学生列表虚拟滚动（超过 100 个学生时）
- 成绩历史分页加载
- 图片资源懒加载

#### 5.4.6 数据一致性保证

**乐观更新**：

- 用户操作后立即更新 UI（乐观假设操作成功）
- 若操作失败，回滚 UI 并提示错误

**数据校验**：

- 所有数据修改前进行校验（如积分必须为正整数）
- 校验失败时阻止操作并提示用户

**冲突处理**：

- 多标签页同时修改同一数据时，采用"最后写入优先"策略
- 关键操作（如删除学生）在多标签页间互斥

---

## 📌 附录

### A. 术语表

| 术语                 | 统一用法   | 禁止用法                       | 说明                                                 |
| -------------------- | ---------- | ------------------------------ | ---------------------------------------------------- |
| **积分**       | 积分       | 分数、点数                     | 学生通过课堂互动获得，可用于抽奖和商店兑换的虚拟货币 |
| **积分奖励**   | 积分奖励   | 加分、奖励积分、给积分         | 教师或系统给予学生积分的操作                         |
| **经验值**     | 经验值     | 经验、exp、经验点              | 学生通过课堂互动和考试成绩获得，用于精灵进化的成长值 |
| **经验值奖励** | 经验值奖励 | 加经验、奖励经验、给经验值     | 教师或系统给予学生经验值的操作                       |
| **精灵形象**   | 精灵形象   | 精灵图片、精灵图、精灵图像     | 精灵在界面上的视觉展示                               |
| **精灵进化**   | 精灵进化   | 精灵升级、精灵进阶             | 当经验值达到阈值时，精灵自动升级到下一阶段           |
| **精灵品种**   | 精灵品种   | 精灵种类、精灵类型             | 学生选择的精灵类型，影响精灵形象展示                 |
| **进化阶段**   | 进化阶段   | 等级、阶段、Level              | 精灵的等级，共 9 个阶段                              |
| **学生卡片**   | 学生卡片   | 卡片（单独使用时）、学生信息卡 | 主页面显示学生信息的界面元素                         |
| **批量操作**   | 批量操作   | 批量处理、批量修改             | 同时对多个学生执行相同操作                           |
| **撤销/重做**  | 撤销/重做  | 回退、还原                     | 针对批量操作的容错机制，支持恢复操作前状态           |

### B. 图片资源说明

#### B.1 资源目录结构

```
images/
├── 星尘神兽/
│   ├── 精灵蛋.png
│   ├── 萌新宝宝.png
│   ├── 活力小宝.png
│   ├── 成长小精灵.png
│   ├── 智慧精灵.png
│   ├── 勇敢战士.png
│   ├── 闪耀明星.png
│   ├── 魔法大师.png
│   └── 终极神兽.png
├── 灵鹿神兽/
│   ├── 精灵蛋.png
│   ├── 萌新宝宝.png
│   ├── 活力小宝.png
│   ├── 成长小精灵.png
│   ├── 智慧精灵.png
│   ├── 勇敢战士.png
│   ├── 闪耀明星.png
│   ├── 魔法大师.png
│   └── 终极神兽.png
└── 彩雾神兽/
    ├── 精灵蛋.png
    ├── 萌新宝宝.png
    ├── 活力小宝.png
    ├── 成长小精灵.png
    ├── 智慧精灵.png
    ├── 勇敢战士.png
    ├── 闪耀明星.png
    ├── 魔法大师.png
    └── 终极神兽.png
```

#### B.2 文件命名规则

**目录命名**：

- 一级目录名称与精灵品种名称完全一致：`星尘神兽`、`灵鹿神兽`、`彩雾神兽`

**文件命名**：

- 文件名与进化阶段名称完全一致
- 文件格式：PNG（透明背景）
- 命名示例：`精灵蛋.png`、`萌新宝宝.png`、`终极神兽.png`

#### B.3 图片资源路径规则

**路径格式**：

```
images/{精灵品种}/{阶段名称}.png
```

**示例**：

```
images/星尘神兽/精灵蛋.png
images/灵鹿神兽/智慧精灵.png
images/彩雾神兽/终极神兽.png
```

#### B.4 图片规格要求

| 规格项             | 要求                       | 说明                         |
| ------------------ | -------------------------- | ---------------------------- |
| **图片格式** | PNG                        | 支持透明背景                 |
| **推荐尺寸** | 512×512 像素              | 保证清晰度和加载速度平衡     |
| **文件大小** | ≤ 500KB                   | 优化加载性能                 |
| **背景**     | 透明背景                   | 适配不同界面主题             |
| **视觉风格** | 可爱、色彩鲜明、线条简单   | 适合小学生认知特点           |
| **统一性**   | 同品种各阶段风格保持一致性 | 保证进化过程的视觉连贯性体验 |

#### B.5 资源引用说明

**动态路径拼接**：

系统根据学生的精灵品种和当前进化阶段，动态拼接图片路径：

```javascript
// 伪代码示例
const imagePath = `images/${student.petSpecies}/${stage.name}.png`;
```

**资源预加载**：

- 建议在页面初始化时预加载当前学生的所有阶段图片
- 提升切换阶段时的动画流畅度

**资源缺失处理**：

- 若图片文件不存在，显示占位图
- 在控制台输出错误日志便于调试
- 提示开发者检查文件路径和命名

### C. 版本历史

| 版本 | 日期       | 变更内容                                                                                                                                                                                                                                                                                                                                   |
| ---- | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| v1.0 | 2025-10-01 | 初始版本                                                                                                                                                                                                                                                                                                                                   |
| v2.0 | 2025-11-07 | 文档结构优化、内容精炼、格式统一、补充数据模型                                                                                                                                                                                                                                                                                             |
| v2.1 | 2025-11-07 | 配置模块重组：精简主页面配置，在成绩管理页新增换算规则配置模块，实现"就近配置、模块独立"原则                                                                                                                                                                                                                                               |
| v2.2 | 2025-11-07 | 新增精灵进化自定义配置功能：支持每级经验值和升级奖励积分的完全自定义，简化配置流程                                                                                                                                                                                                                                                         |
| v2.3 | 2025-11-07 | 优化成绩导入模块：改用横向科目列格式，移除考试日期字段，简化录入流程，提升批量导入效率                                                                                                                                                                                                                                                     |
| v2.4 | 2025-11-07 | 新增首页快速成绩录入功能：在学生卡片上添加快速操作按钮，支持直接录入成绩，提升课堂即时录入效率                                                                                                                                                                                                                                             |
| v2.5 | 2025-11-07 | 优化卡片快速操作设计：精简为2个按钮（成绩录入、奖励加分），合并积分和经验操作，提升交互效率                                                                                                                                                                                                                                                |
| v2.6 | 2025-11-07 | 确立正向激励机制：移除所有扣分功能，系统仅支持积分和经验值的正向奖励，营造积极的激励氛围                                                                                                                                                                                                                                                   |
| v2.7 | 2025-11-08 | 补充精灵品种体系：新增精灵品种详细说明、选择对话框设计、图片资源规范，统一页面标题命名，完善文档                                                                                                                                                                                                                                           |
| v2.8 | 2025-11-08 | 抽奖形式优化：将翻牌抽奖改为转盘抽奖，新增转盘视觉设计、动画效果、概率配置、历史记录等功能模块                                                                                                                                                                                                                                             |
| v2.9 | 2025-11-08 | 简化转盘抽奖设计：移除中奖概率和奖品等级配置，采用均等概率算法，使用彩虹色系，简化配置流程和操作                                                                                                                                                                                                                                           |
| v3.0 | 2025-11-08 | 逻辑优化版：修正转盘抽奖库存处理逻辑（增加重抽机制和退还积分机制）；明确精灵品种选择触发时机和优先级；补充学生删除功能详细说明（单个删除、批量删除、删除影响范围、撤销机制）；补充科目管理功能（科目添加、编辑、删除、默认科目、与成绩录入的关系）；补充数据同步技术实现（全局状态管理、跨页面同步、数据持久化、性能优化、数据一致性保证） |
| v3.1 | 2025-11-08 | 细节优化版：明确连续升级规则（触发最后一次动画，奖励积分叠加）；优化库存为0商品处理（不显示在列表中）；明确重复成绩处理（追加模式，历史列表显示）；补充姓名处理规则（忽略前后空格）；明确学生ID生成规则（UUID v4）；优化积分历史记录数据结构（区分操作类型、记录积分来源和消耗）；补充批量操作交互设计（复选框模式）；统一全文术语规范     |
| v3.2 | 2025-11-08 | 简化与优化版：简化转盘抽奖库存处理逻辑（移除重抽机制，采用抽奖前过滤）；明确精灵品种选择触发机制（首次操作=点击按钮，卡片置灰=不展示精灵形象）；优化批量导入成绩预览（展示Excel原始数据+有效性标识+统计信息）；新增随机点名排除功能（点名池管理，确保公平性）；统一历史记录管理规则（所有历史记录保留最近15条，超过自动删除最早记录）      |
| v3.3 | 2025-11-08 | 数据一致性优化版：修正学生数据导入导出格式匹配问题，导出功能移除"进化阶段"字段（由经验值自动计算），确保导出数据可直接用于批量导入，无需额外处理                                                                                                                                                                                           |
| v3.4 | 2025-11-08 | 备份逻辑完善版：修正备份内容不完整问题（补全studentId、精灵品种、历史记录、成绩数据等关键字段）；区分自动备份（IndexedDB）和手动备份（本地文件）的存储机制；新增恢复前临时备份保护机制（24小时有效期）；新增备份管理页面（自动备份列表、临时备份列表、手动备份区域、操作日志）；完善数据验证规则和恢复流程                                 |

### D. 参考资料

- [Gamification in Education](https://en.wikipedia.org/wiki/Gamification_of_learning)
- [Progressive Web Apps](https://web.dev/progressive-web-apps/)
- [User Experience Design Principles](https://www.nngroup.com/articles/)

---

**文档结束**
